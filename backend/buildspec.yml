version: 0.2

env:
  variables:
    NODE_ENV: production

phases:
  install:
    commands:
      - echo Installing dependencies...
      - cd backend
      - npm ci

  build:
    commands:
      - echo Compiling TypeScript...
      - npx tsc

      - echo Installing production dependencies in dist...
      - cp package*.json dist/
      - cd dist
      - npm ci --only=production

      - echo Creating deployment package...
      - zip -r lambda-deployment.zip . 

  post_build:
    commands:
      - echo Updating Lambda...
      - aws lambda update-function-code \
          --function-name $LAMBDA_FUNCTION_NAME \
          --zip-file fileb://lambda-deployment.zip

      - echo Waiting for update...
      - aws lambda wait function-updated \
          --function-name $LAMBDA_FUNCTION_NAME

artifacts:
  files:
    - lambda-deployment.zip
  base-directory: backend/dist


cache:
  paths:
    - 'backend/node_modules/**/*'
